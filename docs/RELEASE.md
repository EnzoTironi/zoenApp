# Release Process

This document describes the release process for Screenpipe, which uses GitHub Releases for distribution and automatic updates.

## Overview

The release workflow has been migrated from CrabNebula Cloud to GitHub Releases. This provides:

- Simpler infrastructure (no external CDN dependency)
- Native GitHub integration
- Free hosting for open-source projects
- Direct control over release artifacts

## How Releases Work

### Automatic Releases

Releases are triggered automatically when a commit message contains `release-app`:

```bash
# Create a release commit
git commit -m "feat: new feature release-app"
git push origin main
```

### Manual Releases

You can also trigger a release manually via GitHub Actions:

1. Go to **Actions** â†’ **Release App**
2. Click **Run workflow**
3. Optional: specify a commit hash and version
4. Click **Run workflow**

### Publishing Releases

To automatically publish a release (not just create a draft), use `release-app-publish`:

```bash
git commit -m "feat: ready for production release-app-publish"
git push origin main
```

## Release Workflow

The release process consists of these jobs:

1. **check_commit**: Determines if a release should be triggered based on commit message
2. **draft**: Creates a draft GitHub release with auto-generated notes
3. **publish-tauri**: Builds the app for all platforms (macOS ARM/x64, Windows x64)
4. **publish-release**: Publishes the release and generates the update manifest
5. **generate-changelog**: Triggers changelog generation on the website repo

## Update Manifest

Tauri's auto-updater requires a `latest.json` manifest file. This is generated by:

```
scripts/generate-update-manifest.js
```

The manifest contains:
- Version number
- Release notes
- Platform-specific download URLs and signatures
- Publication date

### Manifest Format

```json
{
  "version": "v1.0.0",
  "notes": "Release v1.0.0",
  "pub_date": "2024-01-15T10:00:00Z",
  "platforms": {
    "darwin-aarch64": {
      "signature": "base64-encoded-signature",
      "url": "https://github.com/screenpipe/screenpipe/releases/download/v1.0.0/screenpipe_aarch64-apple-darwin.tar.gz"
    },
    "darwin-x86_64": {
      "signature": "base64-encoded-signature",
      "url": "https://github.com/screenpipe/screenpipe/releases/download/v1.0.0/screenpipe_x86_64-apple-darwin.tar.gz"
    },
    "windows-x86_64": {
      "signature": "base64-encoded-signature",
      "url": "https://github.com/screenpipe/screenpipe/releases/download/v1.0.0/screenpipe_x86_64-pc-windows-msvc.msi.zip"
    }
  }
}
```

## Configuration

### Tauri Configuration

The updater endpoint is configured in:

```
apps/screenpipe-app-tauri/src-tauri/tauri.prod.conf.json
```

Current endpoint:
```json
{
  "plugins": {
    "updater": {
      "endpoints": [
        "https://github.com/screenpipe/screenpipe/releases/latest/download/latest.json"
      ]
    }
  }
}
```

### Required Secrets

The following secrets must be configured in GitHub:

| Secret | Description |
|--------|-------------|
| `GITHUB_TOKEN` | Automatically provided, used for release management |
| `TAURI_PRIVATE_KEY` | Private key for signing updates |
| `TAURI_KEY_PASSWORD` | Password for the signing key |
| `APPLE_CERTIFICATE` | macOS signing certificate (base64) |
| `APPLE_CERTIFICATE_PASSWORD` | Certificate password |
| `APPLE_SIGNING_IDENTITY` | Apple signing identity |
| `APPLE_ID` | Apple ID for notarization |
| `APPLE_PASSWORD` | App-specific password for notarization |
| `APPLE_TEAM_ID` | Apple Developer Team ID |
| `SENTRY_AUTH_TOKEN` | For debug symbol upload |
| `RUNNER_CHECK_TOKEN` | For checking self-hosted runner availability |
| `WEBSITE_REPO_TOKEN` | For triggering changelog generation |

## Testing Releases

Before publishing, you can test a release:

1. The workflow creates a **draft** release first
2. Download artifacts from the draft release
3. Test on each platform
4. When ready, publish the release manually or push a `release-app-publish` commit

### Testing Checklist

See [TESTING.md](/TESTING.md) for the full regression checklist.

Key areas to test:
- [ ] App launches successfully
- [ ] Auto-updater detects new version
- [ ] Audio capture works
- [ ] Screen capture works
- [ ] OCR produces correct output
- [ ] Settings persist correctly
- [ ] Tray/dock integration works
- [ ] Window management functions properly

## Troubleshooting

### Release Not Triggering

Check that:
- Commit message contains `release-app`
- Workflow is enabled in GitHub Actions
- Branch protections allow workflow runs

### Build Failures

Common issues:
- **macOS**: Check Xcode version and signing certificates
- **Windows**: Verify vcpkg and LLVM installation
- **Timeouts**: Builds can take 60+ minutes; check runner resources

### Update Not Working

Verify:
- `latest.json` is uploaded to the release
- Signatures are valid (check with `tauri signer verify`)
- Endpoint URL is accessible
- App version is lower than released version

### Signature Mismatch

If users see signature validation errors:
1. Check that `TAURI_PRIVATE_KEY` matches the public key in config
2. Verify signature files are uploaded correctly
3. Ensure no modification of artifacts after signing

## Migration from CrabNebula

If you're migrating from CrabNebula Cloud:

1. Update `tauri.prod.conf.json` endpoint URL
2. Remove `CN_API_KEY` and `CN_APP_SLUG` secrets
3. Update workflow file (already done)
4. Test auto-update from old version to new GitHub-based version

## Beta Releases

For beta/testing releases:

1. Create a pre-release in GitHub
2. Set `prerelease: true` in the workflow (or manually)
3. Users on beta channel will receive the update

To support beta channels, modify the endpoint to include a channel parameter:
```json
"endpoints": [
  "https://github.com/screenpipe/screenpipe/releases/latest/download/latest.json",
  "https://github.com/screenpipe/screenpipe/releases/download/v{{current_version}}/latest.json"
]
```

## Security Considerations

- Keep `TAURI_PRIVATE_KEY` secure and rotate periodically
- Verify all artifacts are signed before release
- Use GitHub's release attestation for additional verification
- Monitor release downloads for anomalies
